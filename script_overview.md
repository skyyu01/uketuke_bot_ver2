# スクリプト全体の処理フロー概要

このドキュメントは、本プロジェクトのスクリプトが、ユーザーの質問を受け付けてから回答を生成し、通知するまでの一連の処理の流れを記述したものです。

---

## ワークフロー1: ユーザーからの質問受付

このフローは、ユーザーがGoogle ChatでBotにメッセージを送信した際に開始されます。

1.  **`onMessage(e)`** (`02_メッセージ処理.js`)
    - Chatからのメッセージイベントを受け取るエントリーポイントです。
    - ユーザーに対し、送信内容を確認するためのカードメッセージ（「はい」「いいえ」ボタン付き）を返信します。

2.  **`handleConfirmationAction(e)`** (`02_メッセージ処理.js`)
    - ユーザーが確認カードの「はい」ボタンを押すと実行されます。
    - 以下の処理を行い、質問を正式に受け付けます。
        - **`saveAttachmentWithSubject_(...)`** (`03_google drive転記.js`): 添付ファイルがある場合、それをGoogle Driveの指定フォルダに保存します。
        - **`appendRowToSheetWithSA_(...)`** (`03_google drive転記.js`): 質問内容、ユーザー情報、タイムスタンプ、添付ファイルリンクなどをスプレッドシートの新しい行に記録します。このとき、回答生成プロセスの起点となる「新規質問」というステータスが設定されます。

---

## ワークフロー2: AIによる回答案の自動生成

このフローは、Google Apps Scriptの「時間ベースのトリガー」によって定期的に実行され、スプレッドシートに溜まった「新規質問」を処理します。

1.  **`generateAnswers()`** (`04_検索エージェント群.js`)
    - 定期実行されるメイン関数です。
    - スプレッドシートをスキャンし、「新規質問」ステータスの行を見つけると、その質問に対して以下の処理を開始します。

2.  **`analyzeQuestion(question)`** (`04_検索エージェント群.js`)
    - 質問文をGemini APIに渡し、内容を分析させます。
    - 「ツール・サービス」と「問い合わせ内容」のカテゴリ分類、および質問の要約を生成します。

3.  **`researchAgent(initialQuestion)`** (`04_検索エージェント群.js`)
    - 回答の根拠となる情報を収集するエージェントです。2つの情報源を調査します。
    - **社内ガイド検索 (RAG):**
        - `getTextFrom...`関数群で社内ドキュメント（Slide, Sheet, Doc）のテキストをすべて読み込みます。
        - `generateSearchKeywords_`関数で質問から検索キーワードを生成します。
        - `chunkText_`関数でドキュメントをチャンク（塊）に分割します。
        - `findRelevantChunks_`関数でキーワードに合致する関連チャンクを複数抽出します。
    - **Web検索:**
        - `generateQuery`関数でWeb検索用のクエリを生成します。
        - `webResearch`関数でGoogle検索を実行し、結果を要約します。
        - `reflection`関数で検索結果を評価し、情報が不十分な場合は追加検索を行います。

4.  **`finalizeAnswer(state)`** (`04_検索エージェント群.js`)
    - `researchAgent`が収集したすべての情報（社内ガイドの関連箇所、Web検索結果）を基に、Gemini APIに最終的な回答案を生成させます。

---

## ワークフロー3: 回答案の通知とレビュー

生成された回答案は、スプレッドシートに保存され、関係者に通知されます。

1.  **`generateAnswers()`** (`04_検索エージェント群.js` 内の続き)
    - `finalizeAnswer`が生成した回答案をスプレッドシートの「geminiでの回答案」列に書き込みます。
    - `saveAnswerLogJson_` (`03`) を呼び出し、生成過程のログをGoogle Driveに保存します。
    - AIによる分析結果（自信度など）に基づき、次のいずれかのフローに分岐します。

2.  **フローA: 自動送付**
    - **`finalizeAndNotify_(...)`** (`05_chatスペース転記.js`)
        - AIの回答に対する自信度が高い場合に選択されます。
        - Chat APIを直接呼び出し、ユーザーのDM（ダイレクトメッセージ）に最終回答を直接送信します。

3.  **フローB: レビュー依頼**
    - **`postReviewCard_(...)`** (`05_chatスペース転記.js`)
        - AIの回答に人間のチェックが必要な場合に選択されます。
        - レビュー担当者向けのChatスペースに、「承認」「差戻」などのボタンが付いたレビュー依頼カードを投稿します。

4.  **`sendNotificationToChat(...)`** (`05_chatスペース転記.js`)
    - 上記のフロー（AまたはB）の後に実行されます。
    - 「新しい回答案が生成されました」という通知カードを、指定されたChatスペースに投稿し、関係者に知らせます。

---

## ワークフロー4: レビュー担当者によるアクション

レビュー担当者がレビューカードのボタンを操作すると、以下のフローが実行されます。

1.  **`doGet(e)` / `doPost(e)`** (`01_webアプリ.js`)
    - レビューカードのボタンには、このWebアプリのURLが設定されています。ボタンがクリックされると、この関数が実行されます。
    - 受け取ったパラメータを `handleReviewAction` に渡します。

2.  **`handleReviewAction(e)`** (`05_chatスペース転記.js`)
    - 「承認」「差戻」などのアクション内容を判別します。
    - **承認の場合:** `finalizeAndNotify_(...)` (`05`) を呼び出し、ユーザーに最終回答をDMで送信します。
    - **差戻の場合:** スプレッドシートのステータスを「差戻」に更新します。
    - アクションの結果をレビュー担当者が見ているChatスペースに返信します。
