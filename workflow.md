# 主要ワークフローにおける関数呼び出しシーケンス

このドキュメントは、ユーザーによる質問の投稿から、回答が生成されてGoogle Chatに通知されるまでの一連の処理の流れと、その中での関数の連続的な呼び出し関係を記述したものです。

---

## ワークフロー: 質問受付から回答生成、通知まで

### ステップ1: 質問の受付とスプレッドシートへの記録

1.  **`onMessage(e)`** (`02_メッセージ処理.js`)
    - ユーザーがChat Botにメッセージを送信すると、この関数が実行されます。
    - 内容確認のためのカードメッセージをユーザーに返します。

2.  **`handleConfirmationAction(e)`** (`02_メッセージ処理.js`)
    - ユーザーが確認カードの「はい」ボタンを押すと、この関数が実行されます。
    - 内部で以下の処理を行います。
        - **`saveAttachmentWithSubject_(...)`** (`03_google drive転記.js`): 添付ファイルがある場合、Google Driveに保存します。
        - **`appendRowToSheetWithSA_(...)`** (`03_google drive転記.js`): 質問内容、ユーザー情報、タイムスタンプなどをスプレッドシートの新しい行に追記します。このとき、ステータス列に「新規質問」と記録されます。

### ステップ2: 回答案の自動生成（トリガー実行）

1.  **`generateAnswers()`** (`04_検索エージェント群.js`)
    - Google Apps Scriptの「時間ベースのトリガー」によって定期的に実行されます。
    - スプレッドシートをスキャンし、ステータスが「新規質問」の行を見つけて、以下の処理をループ実行します。

2.  **`analyzeQuestion(question)`** (`04_検索エージェント群.js`)
    - 質問文をAIで分析し、カテゴリ分類や要約を行います。
    - 内部で **`callGeminiApi(...)`** を呼び出します。

3.  **`researchAgent(initialQuestion)`** (`04_検索エージェント群.js`)
    - 回答を調査・生成する最も中心的な関数です。以下の2つの情報源を並行して調査します。

    - **A) 社内ガイド検索 (RAG)**
        - `getTextFrom...` 関数群 (`04`) を呼び出し、社内ドキュメントの全文を取得します。
        - **`generateSearchKeywords_(...)`** (`04`) → **`callGeminiApi(...)`**: 質問から検索キーワードを生成します。
        - `chunkText_(...)` (`04`): ドキュメントをチャンク（塊）に分割します。
        - `findRelevantChunks_(...)` (`04`): キーワードで関連チャンクを検索し、上位3つを抽出します。

    - **B) Web検索**
        - **`generateQuery(...)`** (`04`) → **`callGeminiApi(...)`**: Web検索用のクエリを生成します。
        - **`webResearch(...)`** (`04`) → **`callGeminiApi(...)`**: Google検索を実行し、結果を要約します。
        - **`reflection(...)`** (`04`) → **`callGeminiApi(...)`**: 検索結果が十分か評価し、不十分なら追加の検索ループを実行します。

4.  **`finalizeAnswer(state)`** (`04_検索エージェント群.js`)
    - 上記のAとBで収集したすべての情報を基に、最終的な回答案を生成します。
    - 内部で **`callGeminiApi(...)`** を呼び出します。

### ステップ3: 結果の保存とGoogle Chatへの通知

`generateAnswers()` 関数は、`researchAgent` から最終回答案を受け取った後、以下の処理を行います。

1.  **`saveAnswerLogJson_(...)`** (`03_google drive転記.js`)
    - 回答生成の過程（使用したクエリ、参照ソースなど）をJSONファイルとしてGoogle Driveに保存します。

2.  **Chat通知（ルート分岐）**
    - AIの分析結果に基づき、回答を「自動送付」するか「レビュー依頼」に出すか分岐します。

    - **レビュー依頼の場合 (今回のエラー発生箇所と推測):**
        - **`postReviewCard_(...)`** (`05_chatスペース転記.js`)
            - レビュー依頼用のカードメッセージを生成し、Webhook経由で指定のChatスペースに投稿します。
            - **エラー原因**: この関数に渡される回答テキスト(`draftAnswer`)に、Chatカードが解釈できない書式や特殊文字が含まれているため、APIが `INVALID_ARGUMENT` エラーを返している可能性が非常に高いです。

3.  **完了通知**
    - **`sendNotificationToChat(...)`** (`05_chatスペース転記.js`)
        - 「回答案が生成されました」という通知カードを、Webhook経由で指定のChatスペースに投稿します。
        - **エラー原因**: こちらも `postReviewCard_` と同様に、回答テキスト(`answer`)の形式がエラーの原因である可能性があります。

---

### 結論

エラーは、**ステップ3**のChat通知部分、特に `postReviewCard_` または `sendNotificationToChat` 関数が、整形されていない回答テキストを受け取ってカードメッセージを生成しようとするところで発生していると断定できます。
